<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AR ê±´ë¬¼ v22</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap');
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Noto Sans KR',sans-serif;background:#000;overflow:hidden}
        #container{position:relative;width:100vw;height:100vh}
        #video{position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;z-index:1}
        #videoCanvas{display:none}
        #overlay{position:absolute;top:0;left:0;width:100%;height:100%;z-index:10;pointer-events:none}
        
        .top-bar{position:absolute;top:0;left:0;right:0;padding:50px 20px 20px;display:flex;justify-content:space-between;align-items:flex-start;z-index:100;pointer-events:none}
        .top-left{display:flex;flex-direction:column;gap:12px;pointer-events:auto}
        .top-right{display:flex;flex-direction:column;align-items:flex-end;gap:8px;pointer-events:auto}
        .icon-btn{width:48px;height:48px;background:rgba(255,255,255,0.95);border-radius:50%;display:flex;align-items:center;justify-content:center;border:none;box-shadow:0 2px 12px rgba(0,0,0,0.15)}
        .icon-btn svg{width:24px;height:24px;fill:#333}
        .detect-info{padding:8px 12px;background:rgba(0,0,0,0.7);border-radius:12px;font-size:11px;color:rgba(255,255,255,0.9);font-weight:500}
        
        /* ë¦¬ì–¼ ë¯¸ë‹ˆë§µ */
        .minimap-container{width:220px;height:220px;border-radius:20px;overflow:hidden;box-shadow:0 4px 20px rgba(0,0,0,0.3);display:none;position:relative}
        .minimap-container.open{display:block}
        .minimap-close{position:absolute;top:10px;left:10px;width:28px;height:28px;background:rgba(0,0,0,0.6);border-radius:50%;border:none;display:flex;align-items:center;justify-content:center;z-index:10}
        .minimap-close svg{width:16px;height:16px;fill:white}
        .minimap{width:100%;height:100%;background:#F5F1EB;position:relative}
        .minimap-block{position:absolute;background:#E8E4DE;border:1px solid #D5D0C8}
        .minimap-block.highlight{background:#FFE4CC;border-color:#FFB380}
        .minimap-road{position:absolute;background:#FFFFFF}
        .minimap-road.horizontal{height:12px;left:0;right:0}
        .minimap-road.vertical{width:12px;top:0;bottom:0}
        .minimap-road.small{background:#FAFAFA}
        .minimap-road.small.horizontal{height:6px}
        .minimap-road.small.vertical{width:6px}
        .minimap-subway{position:absolute;height:6px;border-radius:3px}
        .minimap-subway.red{background:#C8102E}
        .minimap-subway.blue{background:#0052A4}
        .minimap-station{position:absolute;transform:translate(-50%,-50%)}
        .minimap-station-dot{width:18px;height:18px;background:white;border:3px solid #C8102E;border-radius:50%}
        .minimap-station-label{position:absolute;top:22px;left:50%;transform:translateX(-50%);background:#C8102E;color:white;font-size:9px;font-weight:700;padding:2px 6px;border-radius:4px;white-space:nowrap}
        .minimap-poi{position:absolute;transform:translate(-50%,-50%);font-size:10px;color:#666;font-weight:500;white-space:nowrap;background:rgba(255,255,255,0.9);padding:2px 5px;border-radius:3px}
        .minimap-marker{position:absolute;width:28px;height:28px;border-radius:50%;background:linear-gradient(135deg,#3B82F6,#2563EB);display:flex;align-items:center;justify-content:center;color:white;font-size:11px;font-weight:700;transform:translate(-50%,-50%);border:2px solid white;box-shadow:0 2px 8px rgba(59,130,246,0.4)}
        .minimap-marker.active{background:linear-gradient(135deg,#F97316,#EA580C)}
        .minimap-marker.green{background:linear-gradient(135deg,#22C55E,#16A34A)}
        .minimap-current{position:absolute;top:50%;left:50%;width:44px;height:44px;transform:translate(-50%,-50%);z-index:5}
        .minimap-current-dot{width:44px;height:44px;background:linear-gradient(135deg,#3B82F6,#1D4ED8);border-radius:50%;display:flex;align-items:center;justify-content:center;border:3px solid white;box-shadow:0 3px 12px rgba(59,130,246,0.5)}
        .minimap-current-dot svg{width:22px;height:22px;fill:white}
        .minimap-current-pulse{position:absolute;top:50%;left:50%;width:44px;height:44px;background:rgba(59,130,246,0.25);border-radius:50%;transform:translate(-50%,-50%);animation:pulse 2s infinite}
        @keyframes pulse{0%{transform:translate(-50%,-50%) scale(1);opacity:1}100%{transform:translate(-50%,-50%) scale(2.5);opacity:0}}
        
        .mode-ind{padding:10px 16px;background:rgba(255,255,255,0.95);border-radius:20px;font-size:14px;font-weight:500;pointer-events:auto;display:flex;align-items:center;gap:6px;box-shadow:0 2px 12px rgba(0,0,0,0.15)}
        .mode-ind svg{width:16px;height:16px;fill:#6366f1}
        
        .bottom-bar{position:absolute;bottom:0;left:0;right:0;padding:20px 20px 40px;display:flex;justify-content:center;z-index:100;pointer-events:none}
        .bottom-controls{display:flex;gap:8px;padding:8px;background:rgba(255,255,255,0.95);border-radius:30px;pointer-events:auto;box-shadow:0 2px 20px rgba(0,0,0,0.15)}
        .ctrl-btn{width:44px;height:44px;border-radius:50%;display:flex;align-items:center;justify-content:center;border:none}
        .ctrl-btn.pri{background:linear-gradient(135deg,#6366f1,#4f46e5)}
        .ctrl-btn.pri svg{fill:white}
        .ctrl-btn svg{width:22px;height:22px}
        
        /* ê±´ë¬¼ ë¼ë²¨ */
        .building-label{position:absolute;display:flex;flex-direction:column;align-items:center;z-index:50;pointer-events:auto;cursor:pointer}
        .label-card{padding:8px 14px;border-radius:8px;text-align:center;box-shadow:0 2px 12px rgba(0,0,0,0.2)}
        .label-card.orange{background:#F97316}
        .label-card.blue{background:#3B82F6}
        .label-card.purple{background:#8B5CF6}
        .label-card.green{background:#22C55E}
        .label-name{color:white;font-size:13px;font-weight:700}
        .label-dist{color:rgba(255,255,255,0.9);font-size:11px;margin-top:2px}
        .label-actions{display:flex;gap:8px;margin-top:8px}
        .act-btn{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 8px rgba(0,0,0,0.2)}
        .act-btn svg{width:16px;height:16px;fill:white}
        .act-btn.pin.orange{background:#F97316}
        .act-btn.pin.blue{background:#3B82F6}
        .act-btn.pin.purple{background:#8B5CF6}
        .act-btn.pin.green{background:#22C55E}
        
        /* ê¸€ë˜ìŠ¤ëª¨í”¼ì¦˜ íŒ¨ë„ */
        .panel{position:absolute;bottom:0;left:0;right:0;height:75vh;background:rgba(255,255,255,0.15);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border-radius:24px 24px 0 0;z-index:150;transform:translateY(100%);transition:transform 0.4s cubic-bezier(0.16,1,0.3,1);display:flex;flex-direction:column;border:1px solid rgba(255,255,255,0.2);border-bottom:none}
        .panel.open{transform:translateY(0)}
        .panel-handle{width:40px;height:4px;background:rgba(255,255,255,0.4);border-radius:2px;margin:12px auto 0}
        .panel-head{padding:16px 20px;display:flex;justify-content:space-between;align-items:center}
        .panel-title{color:white;font-size:18px;font-weight:700;text-shadow:0 1px 2px rgba(0,0,0,0.3)}
        .panel-close{width:36px;height:36px;border-radius:50%;background:rgba(255,255,255,0.2);border:none;display:flex;align-items:center;justify-content:center}
        .panel-close svg{width:20px;height:20px;fill:white}
        .panel-tabs{display:flex;gap:8px;padding:0 20px 16px}
        .panel-tab{flex:1;padding:12px;border:none;border-radius:12px;background:rgba(255,255,255,0.15);backdrop-filter:blur(10px);color:rgba(255,255,255,0.7);font-size:13px;font-weight:600;transition:all 0.2s;border:1px solid rgba(255,255,255,0.1)}
        .panel-tab.active{background:linear-gradient(135deg,#6366f1,#4f46e5);color:white;border-color:transparent}
        .panel-cards{flex:1;padding:16px 20px;display:flex;flex-direction:column;gap:12px;overflow-y:auto}
        
        /* ê¸€ë˜ìŠ¤ëª¨í”¼ì¦˜ ì¹´ë“œ */
        .card{background:rgba(255,255,255,0.12);backdrop-filter:blur(10px);border-radius:12px;padding:12px;display:flex;gap:10px;align-items:center;border:1px solid rgba(255,255,255,0.15)}
        .card.vacant{background:rgba(34,197,94,0.15);border:1px solid rgba(34,197,94,0.4)}
        .card.highlight{background:rgba(249,115,22,0.15);border:1px solid rgba(249,115,22,0.4)}
        
        /* ë¼ì´ë¸Œ í”¼ë“œ ìŠ¤íƒ€ì¼ */
        .live-header{display:flex;align-items:center;gap:6px;padding:4px 0 10px;color:white;font-size:11px;font-weight:600}
        .live-dot{width:6px;height:6px;background:#EF4444;border-radius:50%;animation:livePulse 1.5s ease-in-out infinite}
        @keyframes livePulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:0.6;transform:scale(0.9)}}
        @keyframes slideIn{from{opacity:0;transform:translateX(-20px)}to{opacity:1;transform:translateX(0)}}
        .live-card{position:relative;overflow:hidden}
        .live-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,rgba(239,68,68,0.5),transparent);animation:liveShimmer 2s infinite}
        @keyframes liveShimmer{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}
        .time-badge{background:rgba(239,68,68,0.2);color:#FCA5A5;padding:2px 6px;border-radius:6px;font-size:9px;font-weight:500}
        .time-badge.new{background:rgba(34,197,94,0.3);color:#86EFAC;animation:badgePulse 1s ease-out}
        @keyframes badgePulse{0%{transform:scale(1.2);background:rgba(34,197,94,0.5)}100%{transform:scale(1)}}
        .live-card.new-feed{animation:newFeedSlide 0.5s ease-out}
        @keyframes newFeedSlide{from{opacity:0;transform:translateY(-20px);background:rgba(34,197,94,0.2)}to{opacity:1;transform:translateY(0)}}
        
        .card-icon{width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
        .card-icon.parking{background:linear-gradient(135deg,#3B82F6,#2563EB)}
        .card-icon.promo{background:linear-gradient(135deg,#22C55E,#16A34A)}
        .card-icon.meeting{background:linear-gradient(135deg,#8B5CF6,#7C3AED)}
        .card-icon.food{background:linear-gradient(135deg,#F97316,#EA580C)}
        .card-icon.elevator{background:linear-gradient(135deg,#EC4899,#DB2777)}
        .card-icon.delivery{background:linear-gradient(135deg,#F59E0B,#D97706)}
        .card-icon.restaurant{background:linear-gradient(135deg,#F97316,#EA580C)}
        .card-icon.cafe{background:linear-gradient(135deg,#8B5CF6,#7C3AED)}
        .card-icon.realestate{background:linear-gradient(135deg,#3B82F6,#2563EB)}
        .card-icon.company{background:linear-gradient(135deg,#10B981,#059669)}
        .card-icon.facility{background:linear-gradient(135deg,#6366F1,#4F46E5)}
        .card-icon svg{width:18px;height:18px;fill:white}
        .card-content{flex:1;min-width:0}
        .card-cat{font-size:10px;font-weight:600;color:rgba(255,255,255,0.6);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:2px}
        .card-name{font-size:13px;font-weight:600;color:white;margin-bottom:2px}
        .card-desc{font-size:11px;color:rgba(255,255,255,0.7);line-height:1.3}
        .card-action{padding:8px 12px;background:rgba(255,255,255,0.2);border:1px solid rgba(255,255,255,0.3);border-radius:16px;color:white;font-size:11px;font-weight:600;white-space:nowrap}
        .floor-logo{width:36px;height:36px;border-radius:10px;background:rgba(255,255,255,0.15);display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0}
        .floor-status{padding:4px 10px;border-radius:10px;font-size:10px;font-weight:600;color:white}
        .floor-status.hiring{background:#F97316}
        .floor-status.vacant-status{background:#22C55E}
        
        /* ìƒì„¸ í˜ì´ì§€ */
        .detail-page{position:absolute;top:0;left:0;width:100%;height:100%;background:linear-gradient(135deg,#1a1a2e,#16213e,#0f3460);z-index:300;transform:translateX(100%);transition:transform 0.4s cubic-bezier(0.16,1,0.3,1);overflow-y:auto}
        .detail-page.open{transform:translateX(0)}
        .detail-header{position:sticky;top:0;padding:50px 20px 16px;background:rgba(26,26,46,0.95);backdrop-filter:blur(10px);display:flex;align-items:center;gap:12px;z-index:10}
        .detail-back{width:40px;height:40px;border-radius:50%;background:rgba(255,255,255,0.1);border:none;display:flex;align-items:center;justify-content:center}
        .detail-back svg{width:24px;height:24px;fill:white}
        .detail-header-title{color:white;font-size:18px;font-weight:700}
        .detail-content{padding:20px}
        .detail-hero{width:100%;height:220px;border-radius:16px;background:linear-gradient(135deg,#6366f1,#4f46e5);display:flex;align-items:center;justify-content:center;margin-bottom:20px;overflow:hidden}
        .detail-hero img{width:100%;height:100%;object-fit:cover}
        .detail-hero svg{width:80px;height:80px;fill:white;opacity:0.5}
        .detail-title{color:white;font-size:24px;font-weight:700;margin-bottom:8px}
        .detail-category{color:#6366f1;font-size:13px;font-weight:600;margin-bottom:16px}
        .detail-description{color:rgba(255,255,255,0.8);font-size:14px;line-height:1.7;margin-bottom:24px}
        .detail-info-list{display:flex;flex-direction:column;gap:12px;margin-bottom:24px}
        .detail-info-item{display:flex;align-items:center;gap:12px;padding:14px;background:rgba(255,255,255,0.05);border-radius:12px}
        .detail-info-icon{width:40px;height:40px;border-radius:10px;background:rgba(99,102,241,0.2);display:flex;align-items:center;justify-content:center}
        .detail-info-icon svg{width:20px;height:20px;fill:#6366f1}
        .detail-info-text{flex:1}
        .detail-info-label{font-size:11px;color:rgba(255,255,255,0.5);margin-bottom:2px}
        .detail-info-value{font-size:14px;color:white;font-weight:500}
        .detail-actions{display:flex;gap:12px}
        .detail-btn{flex:1;padding:16px;border-radius:12px;font-size:14px;font-weight:600;border:none}
        .detail-btn.primary{background:linear-gradient(135deg,#6366f1,#4f46e5);color:white}
        .detail-btn.secondary{background:rgba(255,255,255,0.1);color:white;border:1px solid rgba(255,255,255,0.2)}
        
        .loading{position:absolute;inset:0;background:linear-gradient(135deg,#1a1a2e,#16213e,#0f3460);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:500}
        .loading.hidden{display:none}
        .spinner{width:60px;height:60px;border:3px solid rgba(99,102,241,0.3);border-top-color:#6366f1;border-radius:50%;animation:spin 1s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}
        .loading-text{color:white;font-size:16px;margin-top:20px;font-weight:500}
        .loading-subtext{color:rgba(255,255,255,0.5);font-size:13px;margin-top:8px}
    </style>
</head>
<body>
<div id="container">
    <video id="video" playsinline autoplay muted></video>
    <canvas id="videoCanvas"></canvas>
    <div id="overlay"></div>
    
    <div class="top-bar">
        <div class="top-left">
            <button class="icon-btn" onclick="toggleMinimap()">
                <svg viewBox="0 0 24 24"><path d="M20.5 3l-.16.03L15 5.1 9 3 3.36 4.9c-.21.07-.36.25-.36.48V20.5c0 .28.22.5.5.5l.16-.03L9 18.9l6 2.1 5.64-1.9c.21-.07.36-.25.36-.48V3.5c0-.28-.22-.5-.5-.5zM15 19l-6-2.11V5l6 2.11V19z"/></svg>
            </button>
            <div class="minimap-container" id="minimapContainer">
                <button class="minimap-close" onclick="toggleMinimap()">
                    <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                </button>
                <div class="minimap">
                    <div class="minimap-block" style="top:5%;left:5%;width:25%;height:30%"></div>
                    <div class="minimap-block" style="top:5%;left:70%;width:25%;height:25%"></div>
                    <div class="minimap-block highlight" style="top:40%;left:5%;width:20%;height:25%"></div>
                    <div class="minimap-block" style="top:70%;left:5%;width:30%;height:25%"></div>
                    <div class="minimap-block" style="top:70%;left:60%;width:35%;height:25%"></div>
                    <div class="minimap-road horizontal" style="top:47%"></div>
                    <div class="minimap-road vertical" style="left:47%"></div>
                    <div class="minimap-road small horizontal" style="top:25%"></div>
                    <div class="minimap-road small horizontal" style="top:75%"></div>
                    <div class="minimap-road small vertical" style="left:25%"></div>
                    <div class="minimap-road small vertical" style="left:75%"></div>
                    <div class="minimap-subway red" style="top:44%;left:0;right:0"></div>
                    <div class="minimap-subway blue" style="top:50%;left:0;right:0"></div>
                    <div class="minimap-station" style="top:47%;left:47%">
                        <div class="minimap-station-dot"></div>
                        <div class="minimap-station-label">íŒêµì—­</div>
                    </div>
                    <div class="minimap-poi" style="top:12%;left:15%">ì´ë§ˆíŠ¸24</div>
                    <div class="minimap-poi" style="top:82%;left:18%">ìŠ¤íƒ€ë²…ìŠ¤</div>
                    <div class="minimap-poi" style="top:82%;left:75%">ê·¸ë ˆì´ì¸ </div>
                    <div class="minimap-marker" style="top:30%;left:80%">1</div>
                    <div class="minimap-marker active" style="top:60%;left:70%">2</div>
                    <div class="minimap-marker green" style="top:35%;left:20%">3</div>
                    <div class="minimap-current">
                        <div class="minimap-current-pulse"></div>
                        <div class="minimap-current-dot"><svg viewBox="0 0 24 24"><path d="M12 2L4.5 20.29l.71.71L12 18l6.79 3 .71-.71z"/></svg></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="top-right">
            <div class="mode-ind"><svg viewBox="0 0 24 24"><path d="M12 2L4.5 20.29l.71.71L12 18l6.79 3 .71-.71z"/></svg>ARëª¨ë“œ</div>
            <div class="detect-info" id="detectInfo">ê°ì§€: 0ê°œ</div>
        </div>
    </div>
    
    <div class="bottom-bar" id="bottomBar">
        <div class="bottom-controls">
            <button class="ctrl-btn pri" onclick="resetMemory()"><svg viewBox="0 0 24 24"><path d="M17.65 6.35A7.958 7.958 0 0012 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0112 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg></button>
        </div>
    </div>
    
    <div class="panel" id="panel">
        <div class="panel-handle"></div>
        <div class="panel-head">
            <span class="panel-title" id="panelTitle">ê±´ë¬¼</span>
            <button class="panel-close" onclick="closePanel()"><svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button>
        </div>
        <div class="panel-tabs">
            <button class="panel-tab active" data-tab="live" onclick="switchTab('live')">ì§€ê¸ˆì´ìˆœê°„</button>
            <button class="panel-tab" data-tab="custom" onclick="switchTab('custom')">ë§ì¶¤ëª¨ë“œ</button>
            <button class="panel-tab" data-tab="floor" onclick="switchTab('floor')">ì¸µë³„ëª¨ë“œ</button>
        </div>
        <div class="panel-cards" id="panelCards"></div>
    </div>
    
    <div class="detail-page" id="detailPage">
        <div class="detail-header">
            <button class="detail-back" onclick="closeDetail()"><svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg></button>
            <span class="detail-header-title" id="detailHeaderTitle">ìƒì„¸</span>
        </div>
        <div class="detail-content" id="detailContent"></div>
    </div>
    
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <div class="loading-text">AR ëª¨ë¸ ë¡œë”©...</div>
        <div class="loading-subtext">ì¹´ë©”ë¼ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”</div>
    </div>
</div>

<script>
let video, overlay, model, videoCanvas, ctx;
let isRunning = false;
let buildingMemory = [], activeTrackers = new Map();
let nextBuildingIndex = 0, nextMemoryId = 1, nextTrackerId = 1;

// ê±´ë¬¼ ì¸µë³„ ë°ì´í„°
const buildingFloors = {
    'GSíƒ€ì›Œ': [
        { floor: '40F', company: 'ìŠ¤ì¹´ì´ ë¼ìš´ì§€', logo: 'â˜ï¸', status: '' },
        { floor: '39F', company: 'ì„ì› íšŒì˜ì‹¤', logo: 'ğŸ‘”', status: '' },
        { floor: '35F', company: 'GSí™€ë”©ìŠ¤', logo: 'GS', status: '' },
        { floor: '30F', company: 'GSë¦¬í…Œì¼', logo: 'GS', status: '' },
        { floor: '25F', company: 'ê³µì‹¤', logo: 'ğŸ¢', status: 'vacant', vacant: true },
        { floor: '20F', company: 'GSì—ë„ˆì§€', logo: 'GS', status: '' },
        { floor: '15F', company: 'í…Œí¬ìŠ¤íƒ€íŠ¸ì—…', logo: 'ğŸš€', status: 'hiring', highlight: true },
        { floor: '12F', company: 'AIë²¤ì²˜ìŠ¤', logo: 'ğŸ¤–', status: 'hiring', highlight: true },
        { floor: '10F', company: 'ê³µì‹¤', logo: 'ğŸ¢', status: 'vacant', vacant: true },
        { floor: '5F', company: 'ë²•ë¬´ë²•ì¸', logo: 'âš–ï¸', status: '' },
        { floor: '1F', company: 'ë¡œë¹„/ì¹´í˜', logo: 'â˜•', status: '' },
        { floor: 'B1', company: 'í‘¸ë“œì½”íŠ¸', logo: 'ğŸ½ï¸', status: '' },
        { floor: 'B3', company: 'ì£¼ì°¨ì¥', logo: 'ğŸš—', status: '' },
    ],
    'í…Œí—¤ë€ë¡œ ë¹Œë”©': [
        { floor: '20F', company: 'ìŠ¤íƒ€íŠ¸ì—… í—ˆë¸Œ', logo: 'ğŸš€', status: 'hiring', highlight: true },
        { floor: '15F', company: 'ê³µì‹¤', logo: 'ğŸ¢', status: 'vacant', vacant: true },
        { floor: '10F', company: 'IT ì»¨ì„¤íŒ…', logo: 'ğŸ’»', status: '' },
        { floor: '1F', company: 'í¸ì˜ì ', logo: 'ğŸª', status: '' },
    ]
};

// ì‹¤ì‹œê°„ í”¼ë“œ ë°ì´í„°
const liveFeedData = [
    { icon: 'parking', text: 'B3 ì£¼ì°¨ì¥ 15ìë¦¬ ë¹„ì—ˆì–´ìš”', time: 'ë°©ê¸ˆ ì „', action: 'í™•ì¸' },
    { icon: 'promo', text: '1ì¸µ ì¹´í˜ ì•„ë©”ë¦¬ì¹´ë…¸ 1+1!', time: '2ë¶„ ì „', action: 'ì¿ í°' },
    { icon: 'meeting', text: '15ì¸µ íšŒì˜ì‹¤ C ì˜ˆì•½ ì·¨ì†Œë¨', time: '5ë¶„ ì „', action: 'ì˜ˆì•½' },
    { icon: 'food', text: 'B1 êµ¬ë‚´ì‹ë‹¹ Aì½”ìŠ¤ ë§¤ì§„ ì„ë°•', time: '8ë¶„ ì „', action: 'ë©”ë‰´' },
    { icon: 'elevator', text: 'ì—˜ë¦¬ë² ì´í„° ëŒ€ê¸° í‰ê·  2ë¶„', time: '10ë¶„ ì „', action: '' },
    { icon: 'delivery', text: 'ë¬´ì¸íƒë°°í•¨ 3ì¹¸ ë‚¨ìŒ', time: '15ë¶„ ì „', action: 'ìœ„ì¹˜' },
];

const liveFeedIcons = {
    parking: '<path d="M13 3H6v18h4v-6h3c3.31 0 6-2.69 6-6s-2.69-6-6-6zm.2 8H10V7h3.2c1.1 0 2 .9 2 2s-.9 2-2 2z"/>',
    promo: '<path d="M21.41 11.58l-9-9C12.05 2.22 11.55 2 11 2H4c-1.1 0-2 .9-2 2v7c0 .55.22 1.05.59 1.42l9 9c.36.36.86.58 1.41.58s1.05-.22 1.41-.59l7-7c.37-.36.59-.86.59-1.41 0-.55-.23-1.06-.59-1.42zM5.5 7C4.67 7 4 6.33 4 5.5S4.67 4 5.5 4 7 4.67 7 5.5 6.33 7 5.5 7z"/>',
    meeting: '<path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 3c1.93 0 3.5 1.57 3.5 3.5S13.93 13 12 13s-3.5-1.57-3.5-3.5S10.07 6 12 6zm7 13H5v-.23c0-.62.28-1.2.76-1.58C7.47 15.82 9.64 15 12 15s4.53.82 6.24 2.19c.48.38.76.97.76 1.58V19z"/>',
    food: '<path d="M11 9H9V2H7v7H5V2H3v7c0 2.12 1.66 3.84 3.75 3.97V22h2.5v-9.03C11.34 12.84 13 11.12 13 9V2h-2v7zm5-3v8h2.5v8H21V2c-2.76 0-5 2.24-5 4z"/>',
    elevator: '<path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 3l4 4h-3v4h-2v-4H8l4-4zm4 9H8v-2h8v2z"/>',
    delivery: '<path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-1 16H6c-.55 0-1-.45-1-1V6c0-.55.45-1 1-1h12c.55 0 1 .45 1 1v12c0 .55-.45 1-1 1zm-6-10l-4 4h3v4h2v-4h3l-4-4z"/>'
};

// ê±´ë¬¼ ë°ì´í„°
const buildings = [
    { name: 'GSíƒ€ì›Œ', distance: 125, color: 'orange' },
    { name: 'í…Œí—¤ë€ë¡œ ë¹Œë”©', distance: 85, color: 'blue' },
    { name: 'ì—­ì‚¼ íƒ€ì›Œ', distance: 110, color: 'blue' },
    { name: 'ê°•ë‚¨íŒŒì´ë‚¸ìŠ¤ì„¼í„°', distance: 200, color: 'green' },
    { name: 'ì‚¼ì„±íƒ€ìš´', distance: 180, color: 'orange' }
];

// AR ì¹´ë“œ ë°ì´í„°
const arCardData = {
    restaurant: [{ name: 'ìŠ¤ì‹œ ì˜¤ë§ˆì¹´ì„¸', desc: 'í”„ë¦¬ë¯¸ì—„ ì˜¤ë§ˆì¹´ì„¸', floor: 'B1ì¸µ', rating: '4.8', image: 'https://images.unsplash.com/photo-1579871494447-9811cf80d66c?w=800' }],
    cafe: [{ name: 'ë£¨í”„íƒ‘ ì¹´í˜', desc: 'ì‹œê·¸ë‹ˆì²˜ ë¼ë–¼', floor: '40ì¸µ', rating: '4.7', image: 'https://images.unsplash.com/photo-1501339847302-ac426a4a7cbb?w=800' }],
    parking: [{ name: 'ì‹¤ì‹œê°„ ì£¼ì°¨', desc: 'B3: 15/150 ì—¬ìœ ', floor: 'B2-B3', status: 'ì—¬ìœ ' }],
    realestate: [{ name: '25ì¸µ ê³µì‹¤', desc: 'ì „ìš© 85í‰, ê°•ë‚¨ ì¡°ë§', floor: '25ì¸µ', price: 'ë³´5ì–µ/ì›”2,500ë§Œ', image: 'https://images.unsplash.com/photo-1497366216548-37526070297c?w=800' }],
    company: [{ name: 'í…Œí¬ìŠ¤íƒ€íŠ¸ì—…', desc: 'AI ë¬¼ë¥˜ ì†”ë£¨ì…˜', floor: '15ì¸µ', employees: 'ì±„ìš©ì¤‘ ğŸ”¥', image: 'https://images.unsplash.com/photo-1553877522-43269d4ea984?w=800' }],
    facility: [{ name: 'í”¼íŠ¸ë‹ˆìŠ¤', desc: 'ìµœì‹  ìš´ë™ê¸°êµ¬', floor: 'B2ì¸µ', hours: '06:00-23:00', image: 'https://images.unsplash.com/photo-1534438327276-14e5300c3a48?w=800' }],
    live: [{ name: 'ì§€ê¸ˆ ì´ ìˆœê°„', desc: 'ì‹¤ì‹œê°„ ê±´ë¬¼ í˜„í™©', status: 'LIVE' }]
};

const categoryIcons = {
    restaurant: '<path d="M11 9H9V2H7v7H5V2H3v7c0 2.12 1.66 3.84 3.75 3.97V22h2.5v-9.03C11.34 12.84 13 11.12 13 9V2h-2v7zm5-3v8h2.5v8H21V2c-2.76 0-5 2.24-5 4z"/>',
    cafe: '<path d="M20 3H4v10c0 2.21 1.79 4 4 4h6c2.21 0 4-1.79 4-4v-3h2c1.11 0 2-.89 2-2V5c0-1.11-.89-2-2-2zm0 5h-2V5h2v3zM4 19h16v2H4z"/>',
    parking: '<path d="M13 3H6v18h4v-6h3c3.31 0 6-2.69 6-6s-2.69-6-6-6zm.2 8H10V7h3.2c1.1 0 2 .9 2 2s-.9 2-2 2z"/>',
    realestate: '<path d="M12 3L2 12h3v8h6v-6h2v6h6v-8h3L12 3z"/>',
    company: '<path d="M12 7V3H2v18h20V7H12zM6 19H4v-2h2v2zm0-4H4v-2h2v2zm0-4H4V9h2v2zm0-4H4V5h2v2zm4 12H8v-2h2v2zm0-4H8v-2h2v2zm0-4H8V9h2v2zm0-4H8V5h2v2zm10 12h-8v-2h2v-2h-2v-2h2v-2h-2V9h8v10zm-2-8h-2v2h2v-2zm0 4h-2v2h2v-2z"/>',
    facility: '<path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>',
    live: '<path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>'
};

const categoryNames = {
    restaurant: 'ìŒì‹ì ', cafe: 'ì¹´í˜', parking: 'ì£¼ì°¨ì¥',
    realestate: 'ê³µì‹¤', company: 'ì…ì£¼ê¸°ì—…', facility: 'í¸ì˜ì‹œì„¤', live: 'ì‹¤ì‹œê°„'
};

function toggleMinimap() {
    document.getElementById('minimapContainer').classList.toggle('open');
}

function resetMemory() {
    buildingMemory = [];
    nextBuildingIndex = 0;
    activeTrackers.forEach(t => t.el.remove());
    activeTrackers.clear();
}

let currentBuilding = null;
let currentTab = 'live';

function switchTab(tab) {
    currentTab = tab;
    document.querySelectorAll('.panel-tab').forEach(t => t.classList.remove('active'));
    document.querySelector('.panel-tab[data-tab="'+tab+'"]').classList.add('active');
    renderPanelContent();
}

function renderPanelContent() {
    if (!currentBuilding) return;
    const container = document.getElementById('panelCards');
    let html = '';
    
    if (currentTab === 'live') {
        // ì§€ê¸ˆì´ìˆœê°„ - ì‹¤ì‹œê°„ LIVE í”¼ë“œ
        html = '<div class="live-header"><div class="live-dot"></div><span>ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸</span></div>';
        html += liveFeedData.map((item, i) => 
            '<div class="card live-card" style="animation:slideIn 0.3s ease-out '+(i*0.08)+'s both">'+
            '<div class="card-icon" style="background:'+getIconBg(item.icon)+'"><svg viewBox="0 0 24 24">'+liveFeedIcons[item.icon]+'</svg></div>'+
            '<div class="card-content">'+
            '<div class="card-name">'+item.text+'</div>'+
            '<div class="card-desc" style="display:flex;align-items:center;gap:6px"><span class="time-badge">'+item.time+'</span></div>'+
            '</div>'+
            (item.action ? '<button class="card-action">'+item.action+'</button>' : '')+
            '</div>'
        ).join('');
    } else if (currentTab === 'custom') {
        // ë§ì¶¤ëª¨ë“œ - ê´€ì‹¬ì‚¬ ê¸°ë°˜ AR ì¹´ë“œ
        const categories = ['restaurant', 'cafe', 'parking', 'realestate', 'company', 'facility'];
        categories.forEach(cat => {
            const item = arCardData[cat]?.[0];
            if (!item) return;
            let extra = item.rating ? 'â­'+item.rating : item.price || item.employees || (item.hours ? 'ğŸ•'+item.hours : '') || (item.status || '');
            
            html += '<div class="card">'+
                '<div class="card-icon '+cat+'"><svg viewBox="0 0 24 24">'+categoryIcons[cat]+'</svg></div>'+
                '<div class="card-content">'+
                '<div class="card-cat">'+categoryNames[cat]+'</div>'+
                '<div class="card-name">'+item.name+'</div>'+
                '<div class="card-desc">'+item.desc+(extra ? ' Â· '+extra : '')+'</div>'+
                '</div>'+
                '<button class="card-action" onclick="openDetail(\''+cat+'\',\''+item.name+'\')">ìƒì„¸ë³´ê¸°</button>'+
                '</div>';
        });
    } else if (currentTab === 'floor') {
        // ì¸µë³„ëª¨ë“œ - ì¸µë³„ ì •ë³´
        const buildingName = currentBuilding.name;
        const floors = buildingFloors[buildingName] || buildingFloors['GSíƒ€ì›Œ'];
        
        html = floors.map(f => 
            '<div class="card" style="'+(f.vacant?'border:1px solid #22C55E;background:rgba(34,197,94,0.15)':f.highlight?'border:1px solid #F97316;background:rgba(249,115,22,0.15)':'')+'">'+
            '<div style="width:50px;height:50px;border-radius:12px;background:rgba(255,255,255,0.1);display:flex;align-items:center;justify-content:center;font-size:20px">'+f.logo+'</div>'+
            '<div class="card-content">'+
            '<div style="font-size:11px;color:rgba(255,255,255,0.5);margin-bottom:4px">'+f.floor+'</div>'+
            '<div class="card-name">'+f.company+'</div>'+
            '</div>'+
            (f.status ? '<span style="padding:6px 12px;border-radius:12px;font-size:11px;font-weight:600;background:'+(f.status==='hiring'?'#F97316':'#22C55E')+';color:white">'+(f.status==='hiring'?'ì±„ìš©ì¤‘':'ê³µì‹¤')+'</span>' : '')+
            '</div>'
        ).join('');
    }
    
    container.innerHTML = html;
}

function getIconBg(icon) {
    const colors = {parking:'#3B82F6',promo:'#22C55E',meeting:'#8B5CF6',food:'#F97316',elevator:'#EC4899',delivery:'#F59E0B'};
    return colors[icon] || '#6366f1';
}

function openPanel(building) {
    currentBuilding = building;
    currentTab = 'live';
    document.getElementById('panelTitle').textContent = building.name;
    document.getElementById('panel').classList.add('open');
    document.getElementById('bottomBar').style.display = 'none';
    
    // íƒ­ ì´ˆê¸°í™”
    document.querySelectorAll('.panel-tab').forEach(t => t.classList.remove('active'));
    document.querySelector('.panel-tab[data-tab="live"]').classList.add('active');
    
    renderPanelContent();
    startLiveFeedUpdates();
}

let liveFeedInterval = null;
const newFeedMessages = [
    { icon: 'parking', text: 'B2 ì£¼ì°¨ì¥ ìƒˆë¡œ 3ìë¦¬ ë¹„ì—ˆì–´ìš”', action: 'í™•ì¸' },
    { icon: 'promo', text: 'ì˜¤í›„ í•œì •! ì•„ì´ìŠ¤í¬ë¦¼ í• ì¸', action: 'ì¿ í°' },
    { icon: 'elevator', text: '3ë²ˆ ì—˜ë¦¬ë² ì´í„° ìš´í–‰ ì¬ê°œ', action: '' },
    { icon: 'food', text: 'B1 ìƒëŸ¬ë“œë°” ë¦¬í•„ ì‹œì‘', action: 'ë©”ë‰´' },
    { icon: 'meeting', text: '20ì¸µ ë¯¸íŒ…ë£¸ A ì˜ˆì•½ ê°€ëŠ¥', action: 'ì˜ˆì•½' },
    { icon: 'delivery', text: 'íƒë°° ë„ì°© ì•Œë¦¼: ë¡œë¹„', action: 'ìœ„ì¹˜' },
];

function startLiveFeedUpdates() {
    if (liveFeedInterval) clearInterval(liveFeedInterval);
    liveFeedInterval = setInterval(() => {
        if (currentTab !== 'live') return;
        const container = document.getElementById('panelCards');
        const cards = container.querySelectorAll('.live-card');
        if (cards.length === 0) return;
        
        // ìƒˆ í”¼ë“œ ì¶”ê°€
        const newFeed = newFeedMessages[Math.floor(Math.random() * newFeedMessages.length)];
        const newCard = document.createElement('div');
        newCard.className = 'card live-card new-feed';
        newCard.innerHTML = 
            '<div class="card-icon" style="background:'+getIconBg(newFeed.icon)+'"><svg viewBox="0 0 24 24">'+liveFeedIcons[newFeed.icon]+'</svg></div>'+
            '<div class="card-content">'+
            '<div class="card-name">'+newFeed.text+'</div>'+
            '<div class="card-desc" style="display:flex;align-items:center;gap:6px"><span class="time-badge new">ë°©ê¸ˆ ì „</span></div>'+
            '</div>'+
            (newFeed.action ? '<button class="card-action">'+newFeed.action+'</button>' : '');
        
        // í—¤ë” ë‹¤ìŒì— ì‚½ì…
        const header = container.querySelector('.live-header');
        if (header && header.nextSibling) {
            container.insertBefore(newCard, header.nextSibling);
        }
        
        // ì˜¤ë˜ëœ ì¹´ë“œ ì œê±° (6ê°œ ì´ˆê³¼ì‹œ)
        const allCards = container.querySelectorAll('.live-card');
        if (allCards.length > 6) {
            allCards[allCards.length - 1].remove();
        }
    }, 15000);
}

function closePanel() {
    document.getElementById('panel').classList.remove('open');
    document.getElementById('bottomBar').style.display = 'flex';
    if (liveFeedInterval) clearInterval(liveFeedInterval);
}

function openDetail(category, name) {
    video.style.filter = 'blur(10px) brightness(0.3)';
    document.getElementById('detailPage').classList.add('open');
    document.getElementById('detailHeaderTitle').textContent = name;
    
    const item = arCardData[category]?.find(i => i.name === name) || arCardData[category]?.[0];
    if (!item) return;
    
    let infoHtml = '';
    if (item.floor) infoHtml += '<div class="detail-info-item"><div class="detail-info-icon"><svg viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z"/></svg></div><div class="detail-info-text"><div class="detail-info-label">ìœ„ì¹˜</div><div class="detail-info-value">'+item.floor+'</div></div></div>';
    if (item.rating) infoHtml += '<div class="detail-info-item"><div class="detail-info-icon"><svg viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg></div><div class="detail-info-text"><div class="detail-info-label">í‰ì </div><div class="detail-info-value">'+item.rating+' / 5.0</div></div></div>';
    if (item.price) infoHtml += '<div class="detail-info-item"><div class="detail-info-icon"><svg viewBox="0 0 24 24"><path d="M11.8 10.9c-2.27-.59-3-1.2-3-2.15 0-1.09 1.01-1.85 2.7-1.85 1.78 0 2.44.85 2.5 2.1h2.21c-.07-1.72-1.12-3.3-3.21-3.81V3h-3v2.16c-1.94.42-3.5 1.68-3.5 3.61 0 2.31 1.91 3.46 4.7 4.13 2.5.6 3 1.48 3 2.41 0 .69-.49 1.79-2.7 1.79-2.06 0-2.87-.92-2.98-2.1h-2.2c.12 2.19 1.76 3.42 3.68 3.83V21h3v-2.15c1.95-.37 3.5-1.5 3.5-3.55 0-2.84-2.43-3.81-4.7-4.4z"/></svg></div><div class="detail-info-text"><div class="detail-info-label">ì„ëŒ€ë£Œ</div><div class="detail-info-value">'+item.price+'</div></div></div>';
    if (item.hours) infoHtml += '<div class="detail-info-item"><div class="detail-info-icon"><svg viewBox="0 0 24 24"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/></svg></div><div class="detail-info-text"><div class="detail-info-label">ìš´ì˜ì‹œê°„</div><div class="detail-info-value">'+item.hours+'</div></div></div>';
    if (item.employees) infoHtml += '<div class="detail-info-item"><div class="detail-info-icon"><svg viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg></div><div class="detail-info-text"><div class="detail-info-label">ì±„ìš©</div><div class="detail-info-value">'+item.employees+'</div></div></div>';
    
    const heroImg = item.image ? '<img src="'+item.image+'" alt="'+item.name+'" onerror="this.parentElement.innerHTML=\'<svg viewBox=\\\'0 0 24 24\\\'><path d=\\\'M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z\\\'/></svg>\'">' : '<svg viewBox="0 0 24 24">'+categoryIcons[category]+'</svg>';
    
    document.getElementById('detailContent').innerHTML = 
        '<div class="detail-hero">'+heroImg+'</div>'+
        '<div class="detail-title">'+item.name+'</div>'+
        '<div class="detail-category">'+categoryNames[category]+' Â· '+(currentBuilding?.name || '')+'</div>'+
        '<div class="detail-description">'+item.desc+'</div>'+
        '<div class="detail-info-list">'+infoHtml+'</div>'+
        '<div class="detail-actions">'+
        '<button class="detail-btn secondary" onclick="closeDetail()">ë‹«ê¸°</button>'+
        '<button class="detail-btn primary">ì˜ˆì•½í•˜ê¸°</button>'+
        '</div>';
}

function closeDetail() {
    video.style.filter = '';
    document.getElementById('detailPage').classList.remove('open');
}

function handlePinClick(tid) {
    const t = activeTrackers.get(tid);
    if (t) openPanel(t.building);
}

function createLabel(building, tid) {
    const el = document.createElement('div');
    el.className = 'building-label';
    el.innerHTML = 
        '<div class="label-card '+building.color+'">'+
        '<div class="label-name">'+building.name+'</div>'+
        '<div class="label-dist">'+building.distance+'m</div>'+
        '</div>'+
        '<div class="label-actions">'+
        '<div class="act-btn pin '+building.color+'"><svg viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg></div>'+
        '</div>';
    
    // ë¼ë²¨ ì „ì²´ í´ë¦­/í„°ì¹˜ ê°€ëŠ¥
    el.addEventListener('click', function(e) {
        e.stopPropagation();
        handlePinClick(tid);
    });
    
    el.addEventListener('touchend', function(e) {
        e.preventDefault();
        e.stopPropagation();
        handlePinClick(tid);
    });
    
    overlay.appendChild(el);
    return el;
}

function calcIoU(a, b) {
    const x1 = Math.max(a.x, b.x), y1 = Math.max(a.y, b.y);
    const x2 = Math.min(a.x + a.width, b.x + b.width);
    const y2 = Math.min(a.y + a.height, b.y + b.height);
    if (x2 <= x1 || y2 <= y1) return 0;
    const inter = (x2 - x1) * (y2 - y1);
    return inter / (a.width * a.height + b.width * b.height - inter);
}

function getColorHist(box) {
    try {
        videoCanvas.width = video.videoWidth;
        videoCanvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0);
        const sx = video.videoWidth / window.innerWidth;
        const sy = video.videoHeight / window.innerHeight;
        const x = Math.floor(box.x * sx), y = Math.floor(box.y * sy);
        const w = Math.floor(box.width * sx), h = Math.floor(box.height * sy);
        if (w <= 0 || h <= 0) return null;
        const data = ctx.getImageData(x, y, w, h).data;
        const hist = new Array(12).fill(0);
        let n = 0;
        for (let i = 0; i < data.length; i += 16) {
            hist[Math.floor(data[i]/64)]++;
            hist[4+Math.floor(data[i+1]/64)]++;
            hist[8+Math.floor(data[i+2]/64)]++;
            n++;
        }
        for (let i = 0; i < 12; i++) hist[i] /= n;
        return hist;
    } catch(e) { return null; }
}

function findMemory(box, exclude) {
    const nx = (box.x + box.width/2) / window.innerWidth;
    const ny = (box.y + box.height/2) / window.innerHeight;
    const hist = getColorHist(box);
    let best = null, bestScore = 0.35;
    for (const m of buildingMemory) {
        if (exclude.has(m.id)) continue;
        const dx = nx - m.pos.x, dy = ny - m.pos.y;
        const posScore = Math.max(0, 1 - Math.sqrt(dx*dx + dy*dy) * 2);
        let colorScore = 0.5;
        if (hist && m.hist) {
            let s = 0;
            for (let i = 0; i < 12; i++) s += 1 - Math.abs(hist[i] - m.hist[i]);
            colorScore = s / 12;
        }
        const score = posScore * 0.4 + colorScore * 0.6;
        if (score > bestScore) { bestScore = score; best = m; }
    }
    return best;
}

function register(box) {
    const b = buildings[nextBuildingIndex++ % buildings.length];
    const entry = {
        id: nextMemoryId++,
        building: b,
        pos: {x: (box.x + box.width/2) / window.innerWidth, y: (box.y + box.height/2) / window.innerHeight},
        hist: getColorHist(box)
    };
    buildingMemory.push(entry);
    return entry;
}

function updateMem(m, box) {
    const nx = (box.x + box.width/2) / window.innerWidth;
    const ny = (box.y + box.height/2) / window.innerHeight;
    m.pos.x = m.pos.x * 0.7 + nx * 0.3;
    m.pos.y = m.pos.y * 0.7 + ny * 0.3;
}

function createTracker(box, mem) {
    const tid = nextTrackerId++;
    return {
        id: tid,
        memId: mem.id,
        building: mem.building,
        box: {...box},
        smoothBox: {...box},
        el: createLabel(mem.building, tid),
        lastSeen: Date.now()
    };
}

async function detect() {
    if (!isRunning) return;
    
    try {
        const preds = await model.detect(video);
        const sx = window.innerWidth / video.videoWidth;
        const sy = window.innerHeight / video.videoHeight;
        
        // ê°ì§€ëœ ê°ì²´ (í™•ë¥  í¬í•¨)
        const detected = preds.filter(p => p.class === 'cup' && p.score >= 0.5);
        let boxes = detected.map(p => ({
            x: p.bbox[0] * sx, y: p.bbox[1] * sy,
            width: p.bbox[2] * sx, height: p.bbox[3] * sy,
            score: p.score
        }));
        
        // ê°ì§€ ì •ë³´ ì—…ë°ì´íŠ¸
        const detectInfo = document.getElementById('detectInfo');
        if (detected.length > 0) {
            const avgScore = Math.round(detected.reduce((s,p) => s + p.score, 0) / detected.length * 100);
            detectInfo.textContent = `ê°ì§€: ${detected.length}ê°œ (${avgScore}%)`;
            detectInfo.style.background = 'rgba(34,197,94,0.8)';
        } else {
            detectInfo.textContent = 'ê°ì§€: 0ê°œ';
            detectInfo.style.background = 'rgba(0,0,0,0.7)';
        }
        
        const now = Date.now();
        const matched = new Set(), usedBox = new Set();
        
        for (const [tid, t] of activeTrackers) {
            let bestIoU = 0.3, bestIdx = -1;  // IoU ì„ê³„ê°’ ë†’ì„
            boxes.forEach((b, i) => {
                if (usedBox.has(i)) return;
                const iou = calcIoU(t.box, b);
                if (iou > bestIoU) { bestIoU = iou; bestIdx = i; }
            });
            
            if (bestIdx >= 0) {
                const b = boxes[bestIdx];
                t.box = {...b};
                t.lastSeen = now;
                // ë³´ê°„ ì†ë„ ë†’ì„ (0.7 â†’ 0.85)
                t.smoothBox.x += (b.x - t.smoothBox.x) * 0.85;
                t.smoothBox.y += (b.y - t.smoothBox.y) * 0.85;
                t.smoothBox.width += (b.width - t.smoothBox.width) * 0.85;
                t.smoothBox.height += (b.height - t.smoothBox.height) * 0.85;
                const m = buildingMemory.find(x => x.id === t.memId);
                if (m) updateMem(m, b);
                matched.add(tid);
                usedBox.add(bestIdx);
            }
        }
        
        const usedMem = new Set();
        activeTrackers.forEach(t => usedMem.add(t.memId));
        
        boxes.forEach((b, i) => {
            if (usedBox.has(i)) return;
            let m = findMemory(b, usedMem);
            if (!m) m = register(b);
            else updateMem(m, b);
            usedMem.add(m.id);
            const t = createTracker(b, m);
            activeTrackers.set(t.id, t);
            matched.add(t.id);
        });
        
        for (const [tid, t] of activeTrackers) {
            if (!matched.has(tid)) {
                // ì¦‰ì‹œ ìˆ¨ê¸°ê³  300ms í›„ ì‚­ì œ (ë¹ ë¥¸ ì •ë¦¬)
                t.el.style.opacity = '0';
                t.el.style.pointerEvents = 'none';
                if (now - t.lastSeen > 300) {
                    t.el.remove();
                    activeTrackers.delete(tid);
                }
            }
        }
        
        for (const [tid, t] of activeTrackers) {
            if (matched.has(tid)) {
                // ë¼ë²¨ì„ ê°ì²´ ìƒë‹¨ ì¤‘ì•™ì— ë°°ì¹˜ (ì•½ê°„ ìœ„ë¡œ)
                const centerX = t.smoothBox.x + t.smoothBox.width / 2;
                const topY = t.smoothBox.y - 10; // ê°ì²´ ìƒë‹¨ì—ì„œ 10px ìœ„
                t.el.style.left = centerX + 'px';
                t.el.style.top = topY + 'px';
                t.el.style.transform = 'translate(-50%, -100%)';
                t.el.style.opacity = '1';
                t.el.style.pointerEvents = 'auto';
            }
        }
        
    } catch(e) { console.error(e); }
    
    requestAnimationFrame(detect);
}

async function init() {
    video = document.getElementById('video');
    overlay = document.getElementById('overlay');
    videoCanvas = document.getElementById('videoCanvas');
    ctx = videoCanvas.getContext('2d', {willReadFrequently: true});
    
    try {
        const stream = await navigator.mediaDevices.getUserMedia({
            video: {facingMode:'environment', width:{ideal:1280}, height:{ideal:720}},
            audio: false
        });
        video.srcObject = stream;
        await video.play();
        
        document.querySelector('.loading-text').textContent = 'AI ëª¨ë¸ ë¡œë”©...';
        model = await cocoSsd.load();
        
        document.getElementById('loading').classList.add('hidden');
        isRunning = true;
        detect();
    } catch(e) {
        document.querySelector('.loading-text').textContent = 'ì¹´ë©”ë¼ ì ‘ê·¼ ì‹¤íŒ¨: ' + e.message;
    }
}

window.onload = init;
</script>
</body>
</html>
