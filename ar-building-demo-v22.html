<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AR Í±¥Î¨º v22</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:-apple-system,sans-serif;background:#000;overflow:hidden}
        #container{position:relative;width:100vw;height:100vh}
        #video{position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;z-index:1}
        #videoCanvas{display:none}
        #overlay{position:absolute;top:0;left:0;width:100%;height:100%;z-index:10;pointer-events:none}
        
        .top-bar{position:absolute;top:0;left:0;right:0;padding:50px 20px 20px;display:flex;justify-content:space-between;z-index:100;pointer-events:none}
        .top-left{display:flex;flex-direction:column;gap:12px;pointer-events:auto}
        .icon-btn{width:48px;height:48px;background:rgba(255,255,255,0.95);border-radius:50%;display:flex;align-items:center;justify-content:center;border:none}
        .icon-btn.active{background:linear-gradient(135deg,#6366f1,#4f46e5)}
        .icon-btn.active svg{fill:white}
        .icon-btn svg{width:24px;height:24px;fill:#333}
        
        .minimap{width:200px;height:200px;border-radius:20px;background:linear-gradient(135deg,#e8f0fe,#d2e3fc);display:none;position:relative}
        .minimap.open{display:block}
        .minimap-close{position:absolute;top:8px;left:8px;width:28px;height:28px;background:rgba(0,0,0,0.5);border-radius:50%;border:none;display:flex;align-items:center;justify-content:center}
        .minimap-close svg{width:16px;height:16px;fill:white}
        
        .mode-ind{padding:10px 16px;background:rgba(255,255,255,0.95);border-radius:20px;font-size:14px;font-weight:500;pointer-events:auto}
        
        .bottom-bar{position:absolute;bottom:0;left:0;right:0;padding:20px 20px 40px;display:flex;justify-content:center;z-index:100;pointer-events:none}
        .bottom-controls{display:flex;gap:8px;padding:8px;background:rgba(255,255,255,0.95);border-radius:30px;pointer-events:auto}
        .ctrl-btn{width:44px;height:44px;border-radius:50%;display:flex;align-items:center;justify-content:center;border:none}
        .ctrl-btn.pri{background:linear-gradient(135deg,#6366f1,#4f46e5)}
        .ctrl-btn.pri svg{fill:white}
        .ctrl-btn.sec{background:transparent}
        .ctrl-btn.sec svg{fill:#666}
        .ctrl-btn svg{width:22px;height:22px}
        
        .building-label{position:absolute;display:flex;flex-direction:column;align-items:center;z-index:50;pointer-events:auto}
        .label-card{padding:8px 14px;border-radius:8px;text-align:center}
        .label-card.orange{background:#F97316}
        .label-card.blue{background:#3B82F6}
        .label-card.purple{background:#8B5CF6}
        .label-name{color:white;font-size:13px;font-weight:700}
        .label-dist{color:rgba(255,255,255,0.9);font-size:11px;margin-top:2px}
        
        .label-actions{display:flex;gap:8px;margin-top:8px}
        .act-btn{width:44px;height:44px;border-radius:50%;display:flex;align-items:center;justify-content:center;border:2px solid white}
        .act-btn svg{width:20px;height:20px;fill:white}
        .act-btn.pin.orange{background:#F97316}
        .act-btn.pin.blue{background:#3B82F6}
        .act-btn.pin.purple{background:#8B5CF6}
        .act-btn.xray{background:white}
        .act-btn.xray svg{fill:#6366f1}
        .act-btn.xray.active{background:#6366f1}
        .act-btn.xray.active svg{fill:white}
        
        .xray-box{position:absolute;border:2px solid rgba(99,102,241,0.5);border-radius:12px;background:rgba(99,102,241,0.15);backdrop-filter:blur(2px);display:none;flex-direction:column;z-index:60;pointer-events:auto}
        .xray-box.open{display:flex}
        .xray-head{background:linear-gradient(135deg,#6366f1,#4f46e5);color:white;padding:10px 14px;font-size:13px;font-weight:700;display:flex;justify-content:space-between;align-items:center}
        .xray-head svg{width:16px;height:16px;fill:white}
        .xray-close{width:26px;height:26px;border-radius:50%;background:rgba(255,255,255,0.2);border:none;display:flex;align-items:center;justify-content:center}
        .xray-list{flex:1;padding:4px;display:flex;flex-direction:column;gap:2px;max-height:250px;overflow-y:auto}
        .xray-item{display:flex;align-items:center;gap:8px;padding:10px;border-radius:6px;font-size:12px;color:white;background:rgba(255,255,255,0.1)}
        .xray-item.vacant{background:rgba(34,197,94,0.3);border:1px solid #22C55E}
        .xray-item.highlight{background:rgba(249,115,22,0.3);border:1px solid #F97316}
        
        .live-feed{position:absolute;inset:0;background:rgba(0,0,0,0.9);z-index:200;display:none;flex-direction:column}
        .live-feed.open{display:flex}
        .live-head{display:flex;align-items:center;justify-content:center;gap:10px;padding:60px 20px 20px}
        .live-dot{width:10px;height:10px;background:#EF4444;border-radius:50%;animation:pulse 1.5s infinite}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}
        .live-head span{color:white;font-size:18px;font-weight:700}
        .live-items{flex:1;padding:20px;display:flex;flex-direction:column;gap:10px;overflow-y:auto}
        .live-item{display:flex;align-items:center;gap:14px;padding:16px;background:rgba(255,255,255,0.1);border-radius:16px}
        .live-icon{width:44px;height:44px;border-radius:12px;display:flex;align-items:center;justify-content:center}
        .live-icon.parking{background:#3B82F6}
        .live-icon.promo{background:#22C55E}
        .live-icon.food{background:#F97316}
        .live-icon svg{width:22px;height:22px;fill:white}
        .live-text{color:white;font-size:15px;font-weight:500;flex:1}
        .live-footer{padding:20px 20px 40px;display:flex;justify-content:center}
        .live-close-btn{padding:16px 48px;background:rgba(255,255,255,0.15);border:1px solid rgba(255,255,255,0.3);border-radius:30px;color:white;font-size:16px;font-weight:600}
        
        .panel{position:absolute;bottom:0;left:0;right:0;height:70vh;background:rgba(30,30,50,0.95);backdrop-filter:blur(20px);border-radius:24px 24px 0 0;z-index:150;transform:translateY(100%);transition:transform 0.3s;display:flex;flex-direction:column}
        .panel.open{transform:translateY(0)}
        .panel-head{padding:16px 20px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid rgba(255,255,255,0.1)}
        .panel-title{color:white;font-size:18px;font-weight:700}
        .panel-close{width:36px;height:36px;border-radius:50%;background:rgba(255,255,255,0.2);border:none;display:flex;align-items:center;justify-content:center}
        .panel-close svg{width:20px;height:20px;fill:white}
        .panel-cards{flex:1;padding:16px 20px;display:flex;flex-direction:column;gap:12px;overflow-y:auto}
        .card{background:rgba(255,255,255,0.1);border-radius:16px;padding:16px;display:flex;gap:14px;align-items:center}
        .card-icon{width:50px;height:50px;border-radius:12px;display:flex;align-items:center;justify-content:center}
        .card-icon.live{background:#EF4444}
        .card-icon.parking{background:#3B82F6}
        .card-icon svg{width:26px;height:26px;fill:white}
        .card-content{flex:1}
        .card-name{font-size:15px;font-weight:700;color:white}
        .card-desc{font-size:12px;color:rgba(255,255,255,0.7);margin-top:4px}
        .card-action{padding:10px 16px;background:rgba(255,255,255,0.2);border:none;border-radius:20px;color:white;font-size:12px;font-weight:600}
        
        .loading{position:absolute;inset:0;background:linear-gradient(135deg,#1a1a2e,#16213e);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:500}
        .loading.hidden{display:none}
        .spinner{width:50px;height:50px;border:3px solid rgba(99,102,241,0.3);border-top-color:#6366f1;border-radius:50%;animation:spin 1s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}
        .loading-text{color:white;font-size:16px;margin-top:20px}
    </style>
</head>
<body>
<div id="container">
    <video id="video" playsinline autoplay muted></video>
    <canvas id="videoCanvas"></canvas>
    <div id="overlay"></div>
    
    <div class="xray-box" id="xrayBox">
        <div class="xray-head">
            <span id="xrayTitle">Ï∏µÎ≥Ñ ÏïàÎÇ¥</span>
            <button class="xray-close" onclick="closeXray()"><svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button>
        </div>
        <div class="xray-list" id="xrayList"></div>
    </div>
    
    <div class="top-bar">
        <div class="top-left">
            <button class="icon-btn" id="mapBtn" onclick="toggleMinimap()">
                <svg viewBox="0 0 24 24"><path d="M20.5 3l-.16.03L15 5.1 9 3 3.36 4.9c-.21.07-.36.25-.36.48V20.5c0 .28.22.5.5.5l.16-.03L9 18.9l6 2.1 5.64-1.9c.21-.07.36-.25.36-.48V3.5c0-.28-.22-.5-.5-.5zM15 19l-6-2.11V5l6 2.11V19z"/></svg>
            </button>
            <div class="minimap" id="minimap">
                <button class="minimap-close" onclick="toggleMinimap()"><svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button>
            </div>
        </div>
        <div class="mode-ind">ARÎ™®Îìú</div>
    </div>
    
    <div class="live-feed" id="liveFeed">
        <div class="live-head"><div class="live-dot"></div><span>ÏßÄÍ∏à Ïù¥ ÏàúÍ∞Ñ</span></div>
        <div class="live-items" id="liveItems"></div>
        <div class="live-footer"><button class="live-close-btn" onclick="closeLiveFeed()">Îã´Í∏∞</button></div>
    </div>
    
    <div class="bottom-bar" id="bottomBar">
        <div class="bottom-controls">
            <button class="ctrl-btn pri" onclick="resetMemory()"><svg viewBox="0 0 24 24"><path d="M17.65 6.35A7.958 7.958 0 0012 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0112 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg></button>
        </div>
    </div>
    
    <div class="panel" id="panel">
        <div class="panel-head">
            <span class="panel-title" id="panelTitle">Í±¥Î¨º</span>
            <button class="panel-close" onclick="closePanel()"><svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button>
        </div>
        <div class="panel-cards" id="panelCards"></div>
    </div>
    
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <div class="loading-text">AR Î™®Îç∏ Î°úÎî©...</div>
    </div>
</div>

<script>
let video, overlay, model, videoCanvas, ctx;
let isRunning = false;
let currentXrayTracker = null;
let buildingMemory = [], activeTrackers = new Map();
let nextBuildingIndex = 0, nextMemoryId = 1, nextTrackerId = 1;

const floors = [
    {f:'40F',c:'Ïä§Ïπ¥Ïù¥ÎùºÏö¥ÏßÄ',l:'‚òÅÔ∏è'},
    {f:'25F',c:'Í≥µÏã§',l:'üè¢',vacant:true},
    {f:'15F',c:'ÌÖåÌÅ¨Ïä§ÌÉÄÌä∏ÏóÖ',l:'üöÄ',highlight:true},
    {f:'1F',c:'Î°úÎπÑ/Ïπ¥Ìéò',l:'‚òï'},
    {f:'B1',c:'Ìë∏ÎìúÏΩîÌä∏',l:'üçΩÔ∏è'},
];

const liveData = [
    {icon:'parking',text:'B3 Ï£ºÏ∞®Ïû• 15ÏûêÎ¶¨ Ïó¨Ïú†'},
    {icon:'promo',text:'1Ï∏µ Ïπ¥Ìéò ÏïÑÎ©îÎ¶¨Ïπ¥ÎÖ∏ 1+1'},
    {icon:'food',text:'B1 Íµ¨ÎÇ¥ÏãùÎãπ Îß§ÏßÑÏûÑÎ∞ï'},
];

const buildings = [
    {name:'GSÌÉÄÏõå',distance:125,color:'orange'},
    {name:'ÌÖåÌó§ÎûÄÎ°úÎπåÎî©',distance:85,color:'blue'},
    {name:'Ïó≠ÏÇºÌÉÄÏõå',distance:110,color:'purple'},
];

function toggleMinimap() {
    document.getElementById('minimap').classList.toggle('open');
    document.getElementById('mapBtn').classList.toggle('active');
}

function resetMemory() {
    buildingMemory = [];
    nextBuildingIndex = 0;
    activeTrackers.forEach(t => t.el.remove());
    activeTrackers.clear();
    closeXray();
}

function openXray(tracker) {
    currentXrayTracker = tracker;
    document.getElementById('xrayTitle').textContent = tracker.building.name;
    document.getElementById('xrayList').innerHTML = floors.map(f => 
        '<div class="xray-item '+(f.vacant?'vacant':'')+(f.highlight?' highlight':'')+'">'+
        '<span style="width:30px;font-weight:700">'+f.f+'</span>'+
        '<span>'+f.l+'</span>'+
        '<span style="flex:1">'+f.c+'</span>'+
        '</div>'
    ).join('');
    updateXrayPos();
    document.getElementById('xrayBox').classList.add('open');
}

function updateXrayPos() {
    if (!currentXrayTracker) return;
    const b = currentXrayTracker.smoothBox;
    const el = document.getElementById('xrayBox');
    el.style.left = b.x + 'px';
    el.style.top = b.y + 'px';
    el.style.width = Math.max(200, b.width) + 'px';
    el.style.height = Math.min(260, b.height) + 'px';
}

function closeXray() {
    currentXrayTracker = null;
    document.getElementById('xrayBox').classList.remove('open');
    document.querySelectorAll('.act-btn.xray').forEach(b => b.classList.remove('active'));
}

function openLiveFeed() {
    document.getElementById('liveFeed').classList.add('open');
    document.getElementById('liveItems').innerHTML = liveData.map(d =>
        '<div class="live-item"><div class="live-icon '+d.icon+'"><svg viewBox="0 0 24 24"><path d="M13 3H6v18h4v-6h3c3.31 0 6-2.69 6-6s-2.69-6-6-6z"/></svg></div><div class="live-text">'+d.text+'</div></div>'
    ).join('');
}

function closeLiveFeed() {
    document.getElementById('liveFeed').classList.remove('open');
}

function openPanel(building) {
    document.getElementById('panelTitle').textContent = building.name;
    document.getElementById('panel').classList.add('open');
    document.getElementById('bottomBar').style.display = 'none';
    document.getElementById('panelCards').innerHTML = 
        '<div class="card"><div class="card-icon live"><svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4z"/></svg></div><div class="card-content"><div class="card-name">ÏßÄÍ∏à Ïù¥ ÏàúÍ∞Ñ</div><div class="card-desc">Ïã§ÏãúÍ∞Ñ Í±¥Î¨º ÌòÑÌô©</div></div><button class="card-action" onclick="openLiveFeed();closePanel()">ÌîºÎìú</button></div>'+
        '<div class="card"><div class="card-icon parking"><svg viewBox="0 0 24 24"><path d="M13 3H6v18h4v-6h3c3.31 0 6-2.69 6-6s-2.69-6-6-6z"/></svg></div><div class="card-content"><div class="card-name">Ïã§ÏãúÍ∞Ñ Ï£ºÏ∞®</div><div class="card-desc">B3: 15/150 Ïó¨Ïú†</div></div><button class="card-action">ÏÉÅÏÑ∏</button></div>';
}

function closePanel() {
    document.getElementById('panel').classList.remove('open');
    document.getElementById('bottomBar').style.display = 'flex';
}

function handlePinClick(tid) {
    const t = activeTrackers.get(tid);
    if (t) openPanel(t.building);
}

function handleXrayClick(tid, btn) {
    const t = activeTrackers.get(tid);
    if (!t) return;
    document.querySelectorAll('.act-btn.xray').forEach(b => b.classList.remove('active'));
    if (currentXrayTracker && currentXrayTracker.id === tid) {
        closeXray();
    } else {
        btn.classList.add('active');
        openXray(t);
    }
}

function createLabel(building, tid) {
    const el = document.createElement('div');
    el.className = 'building-label';
    el.innerHTML = 
        '<div class="label-card '+building.color+'">'+
        '<div class="label-name">'+building.name+'</div>'+
        '<div class="label-dist">'+building.distance+'m</div>'+
        '</div>'+
        '<div class="label-actions">'+
        '<div class="act-btn pin '+building.color+'" data-tid="'+tid+'"><svg viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg></div>'+
        '<div class="act-btn xray" data-tid="'+tid+'"><svg viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z"/></svg></div>'+
        '</div>';
    
    const pinBtn = el.querySelector('.act-btn.pin');
    const xrayBtn = el.querySelector('.act-btn.xray');
    
    pinBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        handlePinClick(tid);
    });
    
    xrayBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        handleXrayClick(tid, xrayBtn);
    });
    
    overlay.appendChild(el);
    return el;
}

function calcIoU(a, b) {
    const x1 = Math.max(a.x, b.x), y1 = Math.max(a.y, b.y);
    const x2 = Math.min(a.x + a.width, b.x + b.width);
    const y2 = Math.min(a.y + a.height, b.y + b.height);
    if (x2 <= x1 || y2 <= y1) return 0;
    const inter = (x2 - x1) * (y2 - y1);
    return inter / (a.width * a.height + b.width * b.height - inter);
}

function getColorHist(box) {
    try {
        videoCanvas.width = video.videoWidth;
        videoCanvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0);
        const sx = video.videoWidth / window.innerWidth;
        const sy = video.videoHeight / window.innerHeight;
        const x = Math.floor(box.x * sx), y = Math.floor(box.y * sy);
        const w = Math.floor(box.width * sx), h = Math.floor(box.height * sy);
        if (w <= 0 || h <= 0) return null;
        const data = ctx.getImageData(x, y, w, h).data;
        const hist = new Array(12).fill(0);
        let n = 0;
        for (let i = 0; i < data.length; i += 16) {
            hist[Math.floor(data[i]/64)]++;
            hist[4+Math.floor(data[i+1]/64)]++;
            hist[8+Math.floor(data[i+2]/64)]++;
            n++;
        }
        for (let i = 0; i < 12; i++) hist[i] /= n;
        return hist;
    } catch(e) { return null; }
}

function findMemory(box, exclude) {
    const nx = (box.x + box.width/2) / window.innerWidth;
    const ny = (box.y + box.height/2) / window.innerHeight;
    const hist = getColorHist(box);
    let best = null, bestScore = 0.35;
    for (const m of buildingMemory) {
        if (exclude.has(m.id)) continue;
        const dx = nx - m.pos.x, dy = ny - m.pos.y;
        const posScore = Math.max(0, 1 - Math.sqrt(dx*dx + dy*dy) * 2);
        let colorScore = 0.5;
        if (hist && m.hist) {
            let s = 0;
            for (let i = 0; i < 12; i++) s += 1 - Math.abs(hist[i] - m.hist[i]);
            colorScore = s / 12;
        }
        const score = posScore * 0.4 + colorScore * 0.6;
        if (score > bestScore) { bestScore = score; best = m; }
    }
    return best;
}

function register(box) {
    const b = buildings[nextBuildingIndex++ % buildings.length];
    const entry = {
        id: nextMemoryId++,
        building: b,
        pos: {x: (box.x + box.width/2) / window.innerWidth, y: (box.y + box.height/2) / window.innerHeight},
        hist: getColorHist(box)
    };
    buildingMemory.push(entry);
    return entry;
}

function updateMem(m, box) {
    const nx = (box.x + box.width/2) / window.innerWidth;
    const ny = (box.y + box.height/2) / window.innerHeight;
    m.pos.x = m.pos.x * 0.7 + nx * 0.3;
    m.pos.y = m.pos.y * 0.7 + ny * 0.3;
}

function createTracker(box, mem) {
    const tid = nextTrackerId++;
    return {
        id: tid,
        memId: mem.id,
        building: mem.building,
        box: {...box},
        smoothBox: {...box},
        el: createLabel(mem.building, tid),
        lastSeen: Date.now()
    };
}

async function detect() {
    if (!isRunning) return;
    
    try {
        const preds = await model.detect(video);
        const sx = window.innerWidth / video.videoWidth;
        const sy = window.innerHeight / video.videoHeight;
        
        let boxes = preds.filter(p => p.class === 'cup' && p.score >= 0.6).map(p => ({
            x: p.bbox[0] * sx, y: p.bbox[1] * sy,
            width: p.bbox[2] * sx, height: p.bbox[3] * sy
        }));
        
        const now = Date.now();
        const matched = new Set(), usedBox = new Set();
        
        for (const [tid, t] of activeTrackers) {
            let bestIoU = 0.2, bestIdx = -1;
            boxes.forEach((b, i) => {
                if (usedBox.has(i)) return;
                const iou = calcIoU(t.box, b);
                if (iou > bestIoU) { bestIoU = iou; bestIdx = i; }
            });
            
            if (bestIdx >= 0) {
                const b = boxes[bestIdx];
                t.box = {...b};
                t.lastSeen = now;
                t.smoothBox.x += (b.x - t.smoothBox.x) * 0.7;
                t.smoothBox.y += (b.y - t.smoothBox.y) * 0.7;
                t.smoothBox.width += (b.width - t.smoothBox.width) * 0.7;
                t.smoothBox.height += (b.height - t.smoothBox.height) * 0.7;
                const m = buildingMemory.find(x => x.id === t.memId);
                if (m) updateMem(m, b);
                matched.add(tid);
                usedBox.add(bestIdx);
            }
        }
        
        const usedMem = new Set();
        activeTrackers.forEach(t => usedMem.add(t.memId));
        
        boxes.forEach((b, i) => {
            if (usedBox.has(i)) return;
            let m = findMemory(b, usedMem);
            if (!m) m = register(b);
            else updateMem(m, b);
            usedMem.add(m.id);
            const t = createTracker(b, m);
            activeTrackers.set(t.id, t);
            matched.add(t.id);
        });
        
        for (const [tid, t] of activeTrackers) {
            if (!matched.has(tid)) {
                if (now - t.lastSeen > 500) {
                    t.el.remove();
                    activeTrackers.delete(tid);
                    if (currentXrayTracker?.id === tid) closeXray();
                } else {
                    t.el.style.opacity = '0';
                }
            }
        }
        
        for (const [tid, t] of activeTrackers) {
            if (matched.has(tid)) {
                t.el.style.left = (t.smoothBox.x + t.smoothBox.width/2) + 'px';
                t.el.style.top = t.smoothBox.y + 'px';
                t.el.style.transform = 'translate(-50%, -100%)';
                t.el.style.opacity = '1';
            }
        }
        
        if (currentXrayTracker && activeTrackers.has(currentXrayTracker.id)) updateXrayPos();
        
    } catch(e) { console.error(e); }
    
    requestAnimationFrame(detect);
}

async function init() {
    video = document.getElementById('video');
    overlay = document.getElementById('overlay');
    videoCanvas = document.getElementById('videoCanvas');
    ctx = videoCanvas.getContext('2d', {willReadFrequently: true});
    
    try {
        const stream = await navigator.mediaDevices.getUserMedia({
            video: {facingMode:'environment', width:{ideal:1280}, height:{ideal:720}},
            audio: false
        });
        video.srcObject = stream;
        await video.play();
        
        document.querySelector('.loading-text').textContent = 'AI Î™®Îç∏ Î°úÎî©...';
        model = await cocoSsd.load();
        
        document.getElementById('loading').classList.add('hidden');
        isRunning = true;
        detect();
    } catch(e) {
        document.querySelector('.loading-text').textContent = 'Ïπ¥Î©îÎùº Ï†ëÍ∑º Ïã§Ìå®: ' + e.message;
    }
}

window.onload = init;
</script>
</body>
</html>
